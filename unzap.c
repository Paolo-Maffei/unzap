#include <stdlib.h>
#include <stdint.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

/* phase correct pwm with TOP == OCR0A */
#define TCCR0A_DEFAULT (_BV(WGM00))

#define PWM_ENABLE(freq, duty) {               \
    OCR0A = freq;                              \
    OCR0B = duty;                              \
}
#define PWM_ON()  TCCR0A = (_BV(COM0B1) | (TCCR0A_DEFAULT));
#define PWM_OFF() TCCR0A = (TCCR0A_DEFAULT)

/* prescaler 64 */
#define TIMER1_QUICK_PRESC (_BV(CS11) | _BV(CS10))
/* prescaler 256 */
#define TIMER1_SLOW_PRESC (_BV(CS12))
#define TIMER1_PRESC_MASK (_BV(CS10) | _BV(CS11) | _BV(CS12))

#define TIMER1_QUICK_ON() ( TCCR1B |= TIMER1_QUICK_PRESC )
#define TIMER1_SLOW_ON()  ( TCCR1B |= TIMER1_SLOW_PRESC )
#define TIMER1_OFF() ( TCCR1B &= ~TIMER1_PRESC_MASK )

/* for timer1 with prescaler 256, =^ 250ms */
#define CODE_DELAY 19531

/* prototypes */
void init_pwm(uint8_t, uint8_t);
void start_sending(void);

/* structures */
enum pwm_mode_t {
    PWM_ON = 0,
    PWM_OFF,
    NEXT_CODE,
    PWM_DISABLED,
};

struct pulse_t {
    uint16_t on;
    uint16_t off;
};

/* global variables */
struct pulse_t *next_pulse = NULL;
uint16_t next_off = 0;
enum pwm_mode_t mode = PWM_OFF;

struct pulse_t PROGMEM codes[] = {
    /* first values are for frequency and duty cycle */

    /* code 100 */
    /* {{{ */
    { 36, 7 },
    /* next values are on and off times, in 10usec steps */
    {   853,   288 },
    {   144,   288 },
    {   144,   144 },
    {   144,   144 },
    {   431,   422 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   288,   144 },
    {   144,   288 },
    {   144,   144 },
    {   144, 26709 },
    {   853,   288 },
    {   144,   288 },
    {   144,   144 },
    {   144,   144 },
    {   431,   422 },
    {   144,   144 },
    {   144,   144 },
    {   141,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   144,   144 },
    {   288,   144 },
    {   144,   288 },
    {   144,   144 },
    /* last pulse has a zero off-time */
    {   144,     0 },
    /* }}} */

    /* code 101 */
    /* {{{ */
    { 42, 8},
    {   169,   844 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,  6584 },
    {   169,   838 },
    {   169,   341 },
    {   328,   341 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169, 37403 },
    {   169,   838 },
    {   169,   341 },
    {   328,   341 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,   166 },
    {   169,     0 },

    /* }}} */

    /* code 102 */
    /* {{{ */
    { 38, 8 },
    {   153,   653 },
    {   153,   650 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,   650 },
    {   153,   650 },
    {   153,   650 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,   650 },
    {   153,  1456 },
    {   153, 11191 },
    {   153,   650 },
    {   153,   650 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,   650 },
    {   153,   650 },
    {   153,   650 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,  1456 },
    {   153,   650 },
    {   153,  1456 },
    {   153,     0 },

    /* }}} */

    /* code 103 */
    /* {{{ */
    { 33, 6 },
    {   766,   188 },
    {   384,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   191,   188 },
    {   191,   188 },
    {   191,  8622 },
    {   766,   188 },
    {   384,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   191,   188 },
    {   384,   188 },
    {   191,   188 },
    {   191,   188 },
    {   191,   188 },
    {   191,     0 },


    /* }}} */

    /* code 104 */
    /* {{{ */
    { 35, 7 },
    {  1119,   559 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147, 23941 },
    {  1119,   563 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   138 },
    {   147,   138 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   416 },
    {   147,   138 },
    {   147,   416 },
    {   147,     0 },
    /* }}} */

    /* code 105 */
    /* {{{ */
    { 35, 7 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84, 15400 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84,   606 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84, 13472 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84, 15400 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   253 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84,   606 },
    {    84,   606 },
    {    84,   253 },
    {    84,   606 },
    {    84,     0 },
    /* }}} */

    /* code 106 */
    /* {{{ */
    { 35, 7 },
    {  1463,  1500 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   200 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172, 14350 },
    {  1463,  1500 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   200 },
    {   172,   547 },
    {   172,   200 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,   547 },
    {   172,     0 },
    /* }}} */

    /* code 107 */
    /* {{{ */
    { 33, 6 },
    {  2694,  1347 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   503 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,  7400 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   503 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,  7397 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   503 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,     0 },
    /* }}} */

    /* code 108 */
    /* {{{ */
    { 33, 6 },
    {  2888,  1450 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,     0 },
    /* }}} */

    /* code 109 */
    /* {{{ */
    { 36, 7 },
    {   288,   288 },
    {   575,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   575 },
    {   288,   288 },
    {   575,   288 },
    {   288, 28803 },
    {   284,   288 },
    {   575,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   288 },
    {   288,   575 },
    {   288,   288 },
    {   575,   288 },
    {   288,     0 },
    /* }}} */

    /* code 110 */
    /* {{{ */
    { 33, 6 },
    {  2888,  1450 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,     0 },
    /* }}} */

    /* code 111 */
    /* {{{ */
    { 35, 7 },
    {  2888,  1444 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175, 12672 },
    {  2894,   719 },
    {   175, 30803 },
    {  2894,   719 },
    {   175,     0 },
    /* }}} */

    /* code 112 */
    /* {{{ */
    { 35, 7 },
    {  2875,  1344 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,  7381 },
    {  2878,  1438 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   184 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,   547 },
    {   175,     0 },
    /* }}} */

    /* code 113 */
    /* {{{ */
    { 35, 7 },
    {  2569,  1278 },
    {   159,   163 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   163 },
    {   159,   163 },
    {   159,  1278 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   163 },
    {   159,   163 },
    {   159,  7491 },
    {  2569,  1278 },
    {   159,   163 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   163 },
    {   159,   163 },
    {   159,  1278 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   509 },
    {   159,   163 },
    {   159,   163 },
    {   159,   163 },
    {   159,     0 },
    /* }}} */

    /* code 114 */
    /* {{{ */
    { 35, 7 },
    {  2738,  1359 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,  8156 },
    {  2741,  1356 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,  8156 },
    {  2741,  1356 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   169 },
    {   175,   169 },
    {   175,   169 },
    {   175,   497 },
    {   175,   497 },
    {   175,   497 },
    {   175,     0 },
    /* }}} */

    /* code 115 */
    /* {{{ */
    { 38, 8 },
    {    97,   675 },
    {    97,   681 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,  8888 },
    {    97,   681 },
    {    97,   681 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   681 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,   288 },
    {    97,     0 },
    /* }}} */

    /* code 116 */
    /* {{{ */
    { 33, 7 },
    {  2888,  1450 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,     0 },
    /* }}} */

    /* code 117 */
    /* {{{ */
    { 33, 7 },
    {  2713,  1334 },
    {   166,   166 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,  1338 },
    {   166,   166 },
    {   166,   503 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,  7834 },
    {  2713,  1338 },
    {   166,   166 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,  1338 },
    {   166,   166 },
    {   166,   503 },
    {   166,   503 },
    {   166,   503 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   166,   166 },
    {   163,     0 },
    /* }}} */

    /* code 118 */
    /* {{{ */
    { 35, 7 },
    {   159,   959 },
    {   159,  3206 },
    {   159,   966 },
    {   159,  3206 },
    {   159,   966 },
    {   159,  3206 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,  2084 },
    {   159,  9622 },
    {   159,   966 },
    {   159,  3206 },
    {   159,   966 },
    {   159,  3206 },
    {   159,   966 },
    {   159,  3206 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,   966 },
    {   159,  2084 },
    {   159,     0 },
    /* }}} */

    /* code 119 */
    /* {{{ */
    { 33, 7 },
    {  2888,  1444 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175,   175 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175,   544 },
    {   175, 12672 },
    {  2894,   719 },
    {   175, 30803 },
    {  2894,   719 },
    {   169,     0 },
    /* }}} */

    /* code 120 */
    /* {{{ */
    { 33, 7 },
    {  2888,  1450 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,     0 },
    /* }}} */

    /* code 121 */
    /* {{{ */
    { 33, 6 },

    {  2869,  1438 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   556 },
    {   175,   556 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   556 },
    {   175,   556 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   188 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   556 },
    {   175,   188 },
    {   175,   188 },
    {   175, 14319 },
    {  2878,   716 },
    {   175, 30334 },
    {  2878,   716 },
    {   172,     0 },
    /* }}} */

    /* code 124 */
    /* {{{ */
    { 33, 6 },
    {  2888,  1450 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,     0 },
    /* }}} */

    /* code 131 */
    /* {{{ */
    { 33, 6 },

    {  2888,  1450 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   178 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181,   541 },
    {   181, 12669 },
    {  2894,   719 },
    {   181, 30878 },
    {  2894,   719 },
    {   181,    0 },
    /* }}} */

    /* code NEC */
    /* {{{ */
    { 31, 6 },
    {  2500,  1250 },
    {   156,   156 },
    {   156,   156 },
    {   156,   469 },
    {   156,   156 },
    {   156,   469 },
    {   156,   469 },
    {   156,   469 },
    {   156,   469 },
    {   156,  1250 },
    {   156,   469 },
    {   156,   469 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,     6250 },
    {  2500,  1250 },
    {   156,   156 },
    {   156,   156 },
    {   156,   469 },
    {   156,   156 },
    {   156,   469 },
    {   156,   469 },
    {   156,   469 },
    {   156,   469 },
    {   156,  1250 },
    {   156,   469 },
    {   156,   469 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   156 },
    {   156,   0 },

    /* }}} */

    /* the list is terminated by zeroes */
    { 0, 0 },
};

ISR(TIMER1_COMPA_vect) {
    static uint16_t off = 0;

    /* if button is released, stop sending */
    if (PIND & _BV(PD2)) {
        /* disable pwm and timer and reset mode */
        PWM_OFF();
        TIMER1_OFF();
        mode = PWM_DISABLED;

        /* turn off led */
        PORTC |= _BV(PC5);

        /* re-enable button interrupt */
        EIFR = EIFR;
        EIMSK = _BV(INT0);

        return;
    }

    if (mode == NEXT_CODE) {
        /* load pwm values, advance pointer and enable pwm */
        uint16_t freq, duty;
        freq = pgm_read_word(&next_pulse->on);
        duty = pgm_read_word(&next_pulse->off);

        /* check if we reached the end of codes */
        if (freq == 0 && duty == 0) {
            /* disable timer and pwm */
            mode = PWM_DISABLED;
            TIMER1_OFF();

            /* re-enable button interrupt */
            EIFR = _BV(INTF0);
            EIMSK = _BV(INT0);
        } else {
            PWM_ENABLE(freq, duty);
            TIMER1_OFF();
            TIMER1_QUICK_ON();
            next_pulse++;

            mode = PWM_OFF;
        }

        /* turn off led */
        PORTC |= _BV(PC5);
    }

    if (mode == PWM_ON) {

        PWM_OFF();

        /* check if code is done */
        if (off == 0) {
            /* wait a while, then transmit next code */
            mode = NEXT_CODE;
            TIMER1_OFF();
            TIMER1_SLOW_ON();
            OCR1A = CODE_DELAY;

            /* turn on led */
            PORTC &= ~_BV(PC5);
        } else {
            mode = PWM_OFF;
            OCR1A = off;
        }

    } else if (mode == PWM_OFF) {
        /* load next delays */
        uint16_t on = pgm_read_word(&next_pulse->on);
        off = pgm_read_word(&next_pulse->off);
        next_pulse++;

        OCR1A = on;

        PWM_ON();
        mode = PWM_ON;
    }
}

ISR(INT0_vect) {
    /* start transmitting and disable interrupt */
    start_sending();
    EIMSK = 0;
}

void start_sending(void) {
    /* return if the transmission is already active */
    if (mode != PWM_DISABLED)
        return;

    /* initialize global variables */
    next_pulse = &codes[0];
    mode = NEXT_CODE;
    next_off = 0;

    /* set initial delay */
    OCR1A = 0xffff;

    /* enable timing interrupt */
    TIMSK1 = _BV(OCIE1A);

    /* start timer */
    TIMER1_QUICK_ON();
}

int main(void) {
    /* init output pins */
    DDRD |= _BV(PD6) | _BV(PD5);
    PORTD &= ~(_BV(PD6) | _BV(PD5));

    /* initialize global variables */
    next_pulse = NULL;
    mode = PWM_DISABLED;
    next_off = 0;

    /* init timer0 for pwm, but turn pwm off */
    TCCR0A = TCCR0A_DEFAULT;
    /* prescaler 8, fast pwm with TOP == OCR0A */
    TCCR0B = _BV(CS01) | _BV(WGM02);

    /* init timer1 for delay, in CTC mode */
    TCCR1A = 0;
    TCCR1B = _BV(WGM12);

    /* init button */
    DDRD &= ~_BV(PD2);
    PORTD |= _BV(PD2);

    /* trigger interrupt at falling edge */
    EICRA = _BV(ISC11);
    EIMSK = _BV(INT0);

    /* init led */
    DDRC |= _BV(PC5);
    PORTC |= _BV(PC5);

    sei();

    while(0);
}
